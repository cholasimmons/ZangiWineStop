<cms:php>
    // Sets 'k_mode' (form is for 'edit' or 'new' ?)
    global $PAGE, $CTX, $FUNCS;
    
    $mode = ( $_GET['act']=='create' ) ? 'create' : 'edit'; 
    $CTX->set( 'k_mode', $mode, 'global' );
    
    
    // This gives the link to the edit screen
    function my_get_edit_link( $page_id='' ){
        global $PAGE, $FUNCS;
        
        if( !$page_id ) $page_id=$PAGE->id;
        $nonce = $FUNCS->create_nonce( 'edit_page_'.$page_id );
        $extra = '?act=edit&tpl='.$PAGE->tpl_id.'&p='.$page_id .'&nonce='.$nonce;
        $edit_url = K_ADMIN_URL . K_ADMIN_PAGE . $extra;
        return $edit_url;
    }
</cms:php>

<style>
 
</style>

<div id="admin-content">                   
    <cms:form 
        masterpage=k_template_name 
        mode=k_mode
        page_id=k_page_id
        enctype="multipart/form-data"
        method='post'
        anchor='0'
        add_security_token='0'
        id='frm_edit_page'
        >
        
        <cms:if k_success >
            <cms:db_persist_form 
                k_publish_date="<cms:if frm_my_publish_status='0'>0000-00-00 00:00:00<cms:else/><cms:show frm_my_publish_date /></cms:if>"
                _auto_title='1'
				    k_page_name=nrc
					k_page_title=first_name
            />
			
            
            <cms:if k_success >
                <cms:redirect "<cms:php>echo my_get_edit_link(<cms:show k_last_insert_id />);</cms:php>" />
            </cms:if>
        </cms:if>
        
        <cms:if k_error >
            <div class="alert alert-danger"><strong>Error:</strong> 
                <cms:each k_error >
                    <br><cms:show item />
                </cms:each>
            </div>
        </cms:if>
    
    
        <div id="admin-sidebar" >
            <cms:input type='radio'
              name="my_publish_status" 
              opt_selected="<cms:if k_page_date='0000-00-00 00:00:00' >0<cms:else />1</cms:if>"
              opt_values='Unpublished=0 || Published=1'
            />  
            
            <div id="date-dropdown" style="margin-top: 6px; <cms:if k_page_date='0000-00-00 00:00:00' >visibility:hidden;</cms:if>">
                <cms:input
                    name='my_publish_date'
                    type='datetime'
                    format='mdy'
                    fields_separator=','
                    default_time="<cms:if k_mode='edit' && k_page_date!='0000-00-00 00:00:00'><cms:show k_page_date /><cms:else />@current</cms:if>"
                    required='1'
                /> 
            </div>
            
            <script type="text/javascript">
                window.addEvent('domready', function(){
                    $('my_publish_status0').addEvent('click', function(e){
                        $('date-dropdown').setStyle('visibility', 'hidden')
                    });
                    $('my_publish_status1').addEvent('click', function(e){
                        $('date-dropdown').setStyle('visibility', 'visible')
                    });
                });
            </script>    
        </div>
    

        <!-- EDIT -->  
        <div class="form-group <cms:if k_error_photo >has-error</cms:if>">
            <label class="control-label" for="photo">Passport Photo<span class="required">*</span></label>
            <cms:input class="form-control" id="photo" name="photo" type="bound" value="" />
        </div>
        <div class="form-group <cms:if k_error_first_name || k_error_last_name >has-error</cms:if>">
            <label class="field-label control-label" for="first-name">Name <span class="required">*</span></label>
				<div class="row">
					<div class="col-xs">
						<cms:input class="text form-control" id="first-name" name="first_name" placeholder="First" type="bound" value="" />
					</div><br/>
					<div class="col-xs">
						<cms:input class="form-control" id="last-name" name="last_name" placeholder="Last" type="bound" value="" />
					</div>
            </div>
        </div>
        <div class="form-group <cms:if k_error_email >has-error</cms:if>">
            <label class="control-label" for="email">Email Address <span class="required">*</span></label>
            <cms:input class="form-control" id="email" name="email" type="bound" value="" />
        </div>
        <div class="form-group <cms:if k_error_nrc >has-error</cms:if>">
            <label class="control-label" for="portfolio">N.R.C.</label>
            <cms:input class="form-control" id="nrc" name="nrc" type="bound" placeholder="000000/00/0" />
        </div>


        
        <!-- END EDIT -->
        
        
        <a class="btn btn-primary" id="btn_submit" href="#" onclick="this.style.cursor='wait'; this.fireEvent('my_submit'); $('frm_edit_page').submit(); return false;"><span class="btn-icon">Save</span></a>
        <cms:if k_mode='edit'>
            <a class="btn" id="btn_view" href="<cms:show k_page_link />" target="_blank" onclick="this.blur();"><span class="btn-icon">View</span></a>                            
        </cms:if>    
        
    </cms:form>
</div>

<script type="text/javascript">

    window.addEvent('domready', function(){
        var mySlide = new Fx.Slide('admin-sidebar').hide();
        $('admin-sidebar').setStyle('display', 'block');
        $('toggle').addEvent('click', function(e){
            e = new Event(e);
            mySlide.toggle().chain(function(){
                if (mySlide.open ){
                    $('toggle').removeClass('collapsed').addClass('expanded');
                }
                else{
                    $('toggle').removeClass('expanded').addClass('collapsed');
                }
            });
            e.stop();
        });
    });
                        
    function k_browse_result( id, fileurl ){
        $(id).set( 'value', fileurl );
        try{
            $(id + "_preview").set( {href: fileurl, style:{visibility:'visible'}} );
            $(id + "_img_preview").set( 'src', fileurl );
        }
        catch( e ){}
        
        TB_remove();
    }

    function k_crop_image( tpl_id, page_id, field_id, nonce ){
        var el_notice = 'k_notice_f_' + field_id;
        var el_preview = 'f_'+field_id+'_preview';
        var crop_pos = $('f_k_crop_pos_' + field_id).value;
        var qs = '<cms:show k_admin_link />ajax.php?act=crop&tpl='+tpl_id+'&p='+page_id+'&tb='+encodeURIComponent( field_id )+'&nonce='+ encodeURIComponent( nonce )+'&cp='+encodeURIComponent(crop_pos);
        var requestHTMLData = new Request (
            {
                url: qs,
                onComplete: function(response){
                    if( response=='OK' ){
                        var href = $(el_preview).get('href');
                        if( href.indexOf('?') != -1 ){
                            href = href.substr(0, href.indexOf('?'));
                        }
                        href = href + '?rand=' + Math.random();
                        $(el_preview).set('href', href);
                        try{
                            $('f_'+field_id+'_tb_preview').set('src', href);
                        }
                        catch( e ){}
                        
                        alert('<cms:php> global $FUNCS; echo $FUNCS->t('thumb_recreated'); </cms:php>');
                    }
                    else{
                        alert(response);
                    }
                }
            }
        ).send();
    }
</script>